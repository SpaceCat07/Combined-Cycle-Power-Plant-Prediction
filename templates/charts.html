{% extends "base.html" %}

{% block title %}Charts - Power Plant Predictor{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card fade-in">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Prediction Analytics & Charts
                </h4>
                <p class="mb-0 mt-2">Visualize trends, patterns, and relationships in your power predictions</p>
            </div>
        </div>
    </div>
</div>

{% set chart_data_obj = chart_data|fromjson %}
{% if chart_data_obj.power|length > 0 %}
<div class="row">
    <!-- Main Power Trend Chart -->
    <div class="col-lg-8 mb-4">
        <div class="chart-container slide-in-right">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>Power Output Trend
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="downloadChart('powerTrendChart')">
                    <i class="fas fa-download me-1"></i>Download
                </button>
            </div>
            <canvas id="powerTrendChart" height="80"></canvas>
        </div>
    </div>

    <!-- Quick Statistics -->
    <div class="col-lg-4 mb-4">
        <div class="chart-container slide-in-right" style="animation-delay: 0.1s;">
            <h5 class="mb-3">
                <i class="fas fa-calculator me-2"></i>Quick Statistics
            </h5>
            <div id="quickStats">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Parameters Chart -->
    <div class="col-lg-8 mb-4">
        <div class="chart-container slide-in-right" style="animation-delay: 0.2s;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group me-2"></i>Input Parameters Over Time
                </h5>
                <button class="btn btn-sm btn-outline-success" onclick="downloadChart('parametersChart')">
                    <i class="fas fa-download me-1"></i>Download
                </button>
            </div>
            <canvas id="parametersChart" height="80"></canvas>
        </div>
    </div>

    <!-- Power Distribution -->
    <div class="col-lg-4 mb-4">
        <div class="chart-container slide-in-right" style="animation-delay: 0.3s;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Power Distribution
                </h5>
                <button class="btn btn-sm btn-outline-warning" onclick="downloadChart('powerDistributionChart')">
                    <i class="fas fa-download me-1"></i>Download
                </button>
            </div>
            <canvas id="powerDistributionChart"></canvas>
        </div>
    </div>
</div>

<!-- Scatter Plots -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="chart-container fade-in" style="animation-delay: 0.4s;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-thermometer-half me-2 text-danger"></i>Temperature vs Power
                </h5>
                <button class="btn btn-sm btn-outline-danger" onclick="downloadChart('tempScatterChart')">
                    <i class="fas fa-download me-1"></i>Download
                </button>
            </div>
            <canvas id="tempScatterChart"></canvas>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="chart-container fade-in" style="animation-delay: 0.5s;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2 text-primary"></i>Pressure vs Power
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="downloadChart('pressureScatterChart')">
                    <i class="fas fa-download me-1"></i>Download
                </button>
            </div>
            <canvas id="pressureScatterChart"></canvas>
        </div>
    </div>
</div>

<!-- Correlation Analysis -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="chart-container fade-in" style="animation-delay: 0.6s;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-project-diagram me-2"></i>Parameter Correlation with Power
                </h5>
                <button class="btn btn-sm btn-outline-info" onclick="downloadChart('correlationChart')">
                    <i class="fas fa-download me-1"></i>Download
                </button>
            </div>
            <canvas id="correlationChart"></canvas>
        </div>
    </div>

    <!-- Export All Options -->
    <div class="col-lg-4 mb-4">
        <div class="card fade-in" style="animation-delay: 0.7s;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-download me-2"></i>Export Options
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="downloadAllCharts()">
                        <i class="fas fa-images me-2"></i>Download All Charts
                    </button>
                    <button class="btn btn-success" onclick="generateReport()">
                        <i class="fas fa-file-pdf me-2"></i>Generate Report
                    </button>
                    <button class="btn btn-info" onclick="shareCharts()">
                        <i class="fas fa-share me-2"></i>Share Analytics
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Data State -->
<div class="row">
    <div class="col-12">
        <div class="card fade-in">
            <div class="card-body text-center py-5">
                <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                <h5>No Data for Charts</h5>
                <p class="text-muted mb-4">You need at least one prediction to view charts and analytics.</p>
                <a href="{{ url_for('predict') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-brain me-2"></i>Make Your First Prediction
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
const chartData = {{ chart_data }};
const charts = {};

{% if chart_data_obj.power|length > 0 %}
// Initialize all charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializePowerTrendChart();
    initializeParametersChart();
    initializePowerDistributionChart();
    initializeScatterCharts();
    initializeCorrelationChart();
    updateQuickStats();
});

function initializePowerTrendChart() {
    const ctx = document.getElementById('powerTrendChart').getContext('2d');
    
    charts.powerTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.dates,
            datasets: [{
                label: 'Power Output (MW)',
                data: chartData.power,
                borderColor: 'rgba(52, 152, 219, 1)',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1,
                    cornerRadius: 10
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Power Output (MW)',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Prediction Time',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

function initializeParametersChart() {
    const ctx = document.getElementById('parametersChart').getContext('2d');
    
    charts.parametersChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.dates,
            datasets: [
                {
                    label: 'Temperature (°C)',
                    data: chartData.temperature,
                    borderColor: 'rgba(231, 76, 60, 1)',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Pressure (mbar)',
                    data: chartData.pressure.map(p => p - 950), // Normalize for visibility
                    borderColor: 'rgba(52, 152, 219, 1)',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Humidity (%)',
                    data: chartData.humidity,
                    borderColor: 'rgba(46, 204, 113, 1)',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Vacuum (cm Hg)',
                    data: chartData.vacuum,
                    borderColor: 'rgba(155, 89, 182, 1)',
                    backgroundColor: 'rgba(155, 89, 182, 0.1)',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    cornerRadius: 10,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label === 'Pressure (mbar)') {
                                // Add back the 950 we subtracted for display
                                return label + ': ' + (context.raw + 950).toFixed(2) + ' mbar';
                            }
                            return label + ': ' + context.raw;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Prediction Time'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Normalized Values'
                    }
                }
            }
        }
    });
}

function initializePowerDistributionChart() {
    const ctx = document.getElementById('powerDistributionChart').getContext('2d');
    
    // Create power distribution bins
    const powerValues = chartData.power;
    const min = Math.min(...powerValues);
    const max = Math.max(...powerValues);
    const binCount = Math.min(6, powerValues.length);
    const binSize = (max - min) / binCount;
    
    const bins = Array(binCount).fill(0);
    const binLabels = [];
    
    for (let i = 0; i < binCount; i++) {
        const start = min + i * binSize;
        const end = start + binSize;
        binLabels.push(`${start.toFixed(1)}-${end.toFixed(1)} MW`);
        
        powerValues.forEach(value => {
            if (value >= start && (value <= end || i === binCount - 1)) bins[i]++;
        });
    }
    
    charts.powerDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: binLabels,
            datasets: [{
                data: bins,
                backgroundColor: [
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                    'rgba(243, 156, 18, 0.8)',
                    'rgba(26, 188, 156, 0.8)'
                ],
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ${context.raw} predictions (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function initializeScatterCharts() {
    // Temperature vs Power
    const tempCtx = document.getElementById('tempScatterChart').getContext('2d');
    const tempData = chartData.temperature.map((temp, i) => ({
        x: temp,
        y: chartData.power[i]
    }));
    
    charts.tempScatterChart = new Chart(tempCtx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Temperature vs Power',
                data: tempData,
                backgroundColor: 'rgba(231, 76, 60, 0.6)',
                borderColor: 'rgba(231, 76, 60, 1)',
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Temperature (°C)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Power Output (MW)'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Temperature: ${context.parsed.x}°C, Power: ${context.parsed.y} MW`;
                        }
                    }
                }
            }
        }
    });
    
    // Pressure vs Power
    const pressureCtx = document.getElementById('pressureScatterChart').getContext('2d');
    const pressureData = chartData.pressure.map((pressure, i) => ({
        x: pressure,
        y: chartData.power[i]
    }));
    
    charts.pressureScatterChart = new Chart(pressureCtx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Pressure vs Power',
                data: pressureData,
                backgroundColor: 'rgba(52, 152, 219, 0.6)',
                borderColor: 'rgba(52, 152, 219, 1)',
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Ambient Pressure (mbar)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Power Output (MW)'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Pressure: ${context.parsed.x} mbar, Power: ${context.parsed.y} MW`;
                        }
                    }
                }
            }
        }
    });
}

function initializeCorrelationChart() {
    const ctx = document.getElementById('correlationChart').getContext('2d');
    
    const correlations = [
        calculateCorrelation(chartData.temperature, chartData.power),
        calculateCorrelation(chartData.pressure, chartData.power),
        calculateCorrelation(chartData.humidity, chartData.power),
        calculateCorrelation(chartData.vacuum, chartData.power)
    ];
    
    charts.correlationChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Temperature', 'Pressure', 'Humidity', 'Vacuum'],
            datasets: [{
                label: 'Correlation with Power',
                data: correlations.map(Math.abs), // Show absolute correlation
                backgroundColor: [
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(155, 89, 182, 0.8)'
                ],
                borderColor: [
                    'rgba(231, 76, 60, 1)',
                    'rgba(52, 152, 219, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(155, 89, 182, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Correlation: ${correlations[context.dataIndex].toFixed(3)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1,
                    title: {
                        display: true,
                        text: 'Absolute Correlation'
                    }
                }
            }
        }
    });
}

function calculateCorrelation(x, y) {
    if (x.length !== y.length || x.length === 0) return 0;
    
    const n = x.length;
    const sumX = x.reduce((a, b) => a + b, 0);
    const sumY = y.reduce((a, b) => a + b, 0);
    const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
    const sumXX = x.reduce((sum, xi) => sum + xi * xi, 0);
    const sumYY = y.reduce((sum, yi) => sum + yi * yi, 0);
    
    const numerator = n * sumXY - sumX * sumY;
    const denominator = Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
    
    return denominator === 0 ? 0 : numerator / denominator;
}

function updateQuickStats() {
    const power = chartData.power;
    const avgPower = (power.reduce((a, b) => a + b, 0) / power.length).toFixed(2);
    const maxPower = Math.max(...power).toFixed(2);
    const minPower = Math.min(...power).toFixed(2);
    const stdDev = calculateStandardDeviation(power).toFixed(2);
    const range = (maxPower - minPower).toFixed(2);
    
    document.getElementById('quickStats').innerHTML = `
        <div class="row">
            <div class="col-12 mb-3">
                <div class="stats-card" style="background: var(--gradient-success); padding: 1rem;">
                    <div class="stats-number">${avgPower}</div>
                    <div class="stats-text">Average Power (MW)</div>
                </div>
            </div>
            <div class="col-6 mb-2">
                <strong>Max:</strong><br>
                <span class="text-success">${maxPower} MW</span>
            </div>
            <div class="col-6 mb-2">
                <strong>Min:</strong><br>
                <span class="text-primary">${minPower} MW</span>
            </div>
            <div class="col-6 mb-2">
                <strong>Range:</strong><br>
                <span class="text-warning">${range} MW</span>
            </div>
            <div class="col-6 mb-2">
                <strong>Std Dev:</strong><br>
                <span class="text-info">${stdDev} MW</span>
            </div>
        </div>
    `;
}

function calculateStandardDeviation(values) {
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    const squareDiffs = values.map(value => Math.pow(value - avg, 2));
    const avgSquareDiff = squareDiffs.reduce((a, b) => a + b, 0) / squareDiffs.length;
    return Math.sqrt(avgSquareDiff);
}

function downloadChart(chartId) {
    const chart = charts[chartId];
    if (chart) {
        const url = chart.toBase64Image('image/png', 1.0);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${chartId}_${new Date().toISOString().split('T')[0]}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
}

function downloadAllCharts() {
    Object.keys(charts).forEach((chartId, index) => {
        setTimeout(() => downloadChart(chartId), index * 500);
    });
}

function generateReport() {
    alert('Report generation feature coming soon! For now, you can download individual charts.');
}

function shareCharts() {
    if (navigator.share) {
        navigator.share({
            title: 'Power Plant Prediction Analytics',
            text: 'Check out my power plant prediction analytics!',
            url: window.location.href
        });
    } else {
        // Fallback - copy URL to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert('URL copied to clipboard!');
        });
    }
}
{% endif %}
</script>
{% endblock %}